<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div id="connection-status" class="connection-status">Connected</div>
        <h1>Game Room: {{ game_id }}</h1>
        
        <div id="setup-area">
            <input type="text" id="player-name" placeholder="Enter your name">
            <button onclick="joinGame()">Join Game</button>
        </div>

        <div id="game-area" style="display: none;">
            <div id="scores"></div>
            
            <div class="black-card" id="black-card">
                Waiting for game to start...
            </div>

            <div id="czar-info"></div>
            
            <div class="card-container" id="white-cards"></div>
            
            <div id="game-controls">
                <button onclick="startRound()" id="start-button">Start Round</button>
                <button onclick="submitCard()" id="submit-button" style="display: none;">Submit Card</button>
                <button onclick="judgeRound()" id="judge-button" style="display: none;">Select Winner</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });
        const gameId = "{{ game_id }}";
        let playerName = "";
        let isCardCzar = false;
        let selectedCard = null;

        function joinGame() {
            playerName = document.getElementById("player-name").value;
            if (!playerName) {
                alert("Please enter your name!");
                return;
            }
            document.getElementById("setup-area").style.display = "none";
            document.getElementById("game-area").style.display = "block";
            socket.emit("join_game", { game_id: gameId, player_name: playerName });
            socket.emit("draw_white_cards", { game_id: gameId });
        }

        function startRound() {
            socket.emit("start_round", { game_id: gameId });
        }

        function selectCard(cardElement) {
            if (!cardElement) return;
            
            if (isCardCzar) {
                selectedCard = {
                    text: decodeURIComponent(cardElement.dataset.cardText),
                    player: decodeURIComponent(cardElement.dataset.player || '')
                };
            } else {
                selectedCard = decodeURIComponent(cardElement.dataset.cardText);
            }

            document.querySelectorAll('.white-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');
            document.getElementById("submit-button").style.display = !isCardCzar ? "block" : "none";
            document.getElementById("judge-button").style.display = isCardCzar ? "block" : "none";
        }

        function submitCard() {
            if (!selectedCard) return;
            socket.emit("submit_card", {
                game_id: gameId,
                player_name: playerName,
                white_card: selectedCard
            });
            document.getElementById("submit-button").style.display = "none";
        }

        function judgeRound() {
            if (!selectedCard || !selectedCard.player) {
                alert("Please select a card to judge!");
                return;
            }
            socket.emit("judge_round", {
                game_id: gameId,
                winner: selectedCard.player,
                winning_card: selectedCard.text
            });
        }

        // Add connection handlers
        socket.on('connect', () => {
            document.getElementById('connection-status').textContent = 'Connected';
            document.getElementById('connection-status').className = 'connection-status connected';
            if (playerName) {
                socket.emit("join_game", { game_id: gameId, player_name: playerName });
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('connection-status').textContent = 'Disconnected';
            document.getElementById('connection-status').className = 'connection-status disconnected';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            document.getElementById('connection-status').textContent = 'Connection Error';
            document.getElementById('connection-status').className = 'connection-status error';
        });

        // Add error handling to existing socket events
        socket.on("error", function(error) {
            console.error('Socket error:', error);
            alert('An error occurred. Please try refreshing the page.');
        });

        socket.on("update_players", function(players) {
            const scoresList = Object.entries(players)
                .map(([name, score]) => `${name}: ${score} points`)
                .join("<br>");
            document.getElementById("scores").innerHTML = `<h3>Scores:</h3>${scoresList}`;
        });

        socket.on("new_round", function(data) {
            document.getElementById("black-card").innerText = data.black_card;
            isCardCzar = data.card_czar === playerName;
            document.getElementById("czar-info").innerText = 
                isCardCzar ? "You are the Card Czar!" : `Card Czar: ${data.card_czar}`;
            document.getElementById("start-button").style.display = "none";
            if (!isCardCzar) {
                socket.emit("draw_white_cards", { game_id: gameId });
            }
        });

        // Add this helper function at the top of the script section
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        socket.on("white_card_choices", function(data) {
            const container = document.getElementById("white-cards");
            container.innerHTML = data.white_cards
                .map((card, index) => {
                    const encodedCard = encodeURIComponent(card);
                    return `
                        <div class="card white-card" 
                             id="card-${index}"
                             data-card-text="${encodedCard}"
                             onclick="selectCard(this)">
                            ${card}
                        </div>
                    `;
                }).join("");
        });

        socket.on("update_submissions", function(submissions) {
            if (isCardCzar) {
                const container = document.getElementById("white-cards");
                container.innerHTML = Object.entries(submissions)
                    .map(([player, card], index) => {
                        const encodedCard = encodeURIComponent(card);
                        const encodedPlayer = encodeURIComponent(player);
                        return `
                            <div class="card white-card"
                                 id="card-${index}"
                                 data-card-text="${encodedCard}"
                                 data-player="${encodedPlayer}"
                                 onclick="selectCard(this)">
                                ${card}
                            </div>
                        `;
                    }).join("");
                document.getElementById("judge-button").style.display = "block";
            }
        });

        socket.on("round_winner", function(data) {
            alert(`${data.winner} wins this round! Score: ${data.score}`);
            document.getElementById("start-button").style.display = "block";
            document.getElementById("judge-button").style.display = "none";
            selectedCard = null;  // Reset selected card
            
            // Clear the white cards container
            const container = document.getElementById("white-cards");
            container.innerHTML = "";
        });
    </script>
</body>
</html>


