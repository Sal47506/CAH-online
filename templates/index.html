<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cards Against Hu'Manity</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Cards Against Hu'Manity</h1>

        <!-- Join Game -->
        <div class="join-section mb-4">
            <input type="text" id="player-name" class="form-control mb-2" placeholder="Enter your name">
            <input type="password" id="api-key" class="form-control mb-2" placeholder="Enter your OpenAI API key (for AI Czar)">
            <button class="btn btn-primary btn-block" onclick="joinGame()">Join Game</button>
        </div>

        <!-- AI Czar Toggle -->
        <div class="form-check form-switch mb-4">
            <input class="form-check-input" type="checkbox" id="ai-czar-toggle" onchange="toggleAICzar(this.checked)">
            <label class="form-check-label" for="ai-czar-toggle">Enable AI Card Czar</label>
        </div>

        <!-- Game Info -->
        <div class="game-info mb-4">
            <h2>Round: <span id="round-number">1</span></h2>
            <h2>Card Czar: <span id="card-czar">Waiting...</span></h2>
        </div>

        <!-- Black Card -->
        <div class="black-card-container mb-4">
            <h2>Black Card</h2>
            <div id="black-card" class="card black-card">Click "Start Round" to begin</div>
            <button class="btn btn-success mt-2" onclick="startRound()">Start Round</button>
        </div>

        <!-- White Card Selection -->
        <div class="white-card-selection mb-4">
            <h2>Your White Card Choices</h2>
            <div id="white-cards" class="card-container"></div>
            <button class="btn btn-secondary mt-2" onclick="drawWhiteCards()">Draw White Cards</button>
        </div>

        <!-- Player Scores -->
        <div class="player-scores mb-4">
            <h2>Scores</h2>
            <ul id="player-scores" class="list-group"></ul>
        </div>

        <!-- Judge Section -->
        <div class="judge-section mb-4">
            <h2>Judge Selection</h2>
            <div id="submitted-cards"></div>
        </div>

        <script>
            const socket = io();
            let playerName = "";
            let selectedCard = null;

            function joinGame() {
                playerName = document.getElementById("player-name").value;
                const apiKey = document.getElementById("api-key").value;
                socket.emit("join_game", { 
                    player_name: playerName,
                    api_key: apiKey 
                });
            }

            function startRound() {
                socket.emit("start_round");
            }

            function drawWhiteCards() {
                socket.emit("draw_white_cards");
            }

            function submitCard(card) {
                if (selectedCard) {
                    selectedCard.classList.remove("selected");
                }
                card.classList.add("selected");
                selectedCard = card;
                socket.emit("submit_card", { player_name: playerName, white_card: card.textContent });
            }

            function judgeRound(winner) {
                socket.emit("judge_round", { winner: winner });
            }

            function toggleAICzar(enabled) {
                socket.emit("toggle_ai_czar", { enabled: enabled });
            }

            socket.on("update_players", function(players) {
                let scoreList = document.getElementById("player-scores");
                scoreList.innerHTML = "";
                for (let player in players) {
                    let li = document.createElement("li");
                    li.className = "list-group-item";
                    li.textContent = `${player}: ${players[player]} points`;
                    scoreList.appendChild(li);
                }
            });

            socket.on("new_round", function(data) {
                document.getElementById("black-card").innerText = data.black_card.replace(/_/g, "____");
                document.getElementById("card-czar").innerText = data.card_czar;
            });

            socket.on("white_card_choices", function(data) {
                const whiteCardsDiv = document.getElementById("white-cards");
                whiteCardsDiv.innerHTML = "";
                data.white_cards.forEach(cardText => {
                    const cardButton = document.createElement("button");
                    cardButton.className = "btn btn-light white-card";
                    cardButton.textContent = cardText;
                    cardButton.onclick = () => submitCard(cardButton);
                    whiteCardsDiv.appendChild(cardButton);
                });
            });

            socket.on("update_submissions", function(submissions) {
                let submittedDiv = document.getElementById("submitted-cards");
                submittedDiv.innerHTML = "";
                for (let player in submissions) {
                    let btn = document.createElement("button");
                    btn.className = "btn btn-outline-primary";
                    btn.innerText = `${player}: ${submissions[player]}`;
                    btn.onclick = () => judgeRound(player);
                    submittedDiv.appendChild(btn);
                }
            });

            socket.on("round_winner", function(data) {
                let message = `${data.winner} won this round!`;
                if (data.explanation) {
                    message += `\nAI Czar's explanation: ${data.explanation}`;
                }
                alert(message);
                document.getElementById("round-number").innerText = data.round;
            });
        </script>
    </div>
</body>
</html>
